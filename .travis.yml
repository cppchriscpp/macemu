# I can't for the life of me get this thing building locally, so gonna try to do it on travis, where I can more easily
# play with OS versions/etc
language: cpp

matrix:
  include:
    - os: linux
      dist: trusty
      sudo: required
      compiler: gcc

addons:
  apt:
    sources:
      - deadsnakes
    packages:
      - libsdl1.2-dev 
      - libgtk2.0-dev
      - python3.7
      - python3.7-dev
  artifacts:
    working_dir: BasiliskII
    # Grab everything, hopefully. we can narrow in later.

script:
  # Freaking nasty way to force later python version
  - mkdir -p pythonhax
  - ln -s /usr/bin/python3.7 pythonhax/python && ln -s /usr/bin/python3.7 pythonhax/python3
  - export PATH=$PWD/pythonhax:$PATH
  - cd BasiliskII/src/Unix
  - NO_CONFIGURE=1 ./autogen.sh
  - ./configure --enable-sdl-video --enable-sdl-audio --disable-vosf --disable-jit-compiler --with-x --with-gtk --with-mon
  - make -j 4
  - cd ../../..
  - git clone https://github.com/emscripten-core/emsdk.git
  - cd emsdk
  - ./emsdk install latest
  - ./emsdk activate latest
  - source ./emsdk_env.sh
  - cd ../BasiliskII/src/Unix
  - macemujs_conf_native=1 ./_embuild.sh
  - make
  - echo "If you got here, I am shocked. And in pain. Mostly in pain. Also, $(which python) $(python3 --version)"
  - source ../../../emsdk/emsdk_env.sh
  - macemujs_conf_cpu=1 ./_embuild.sh
  - make mostlyclean && make && ./_emafterbuild.sh
  - cat BasiliskII-worker.html
